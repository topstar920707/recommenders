# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

schedules:
- cron: "0 18 * * *"
  displayName: Daily master cpu testing pipeline
  branches:
    include:
    - master
    - staging

# no PR builds
pr: none

# no CI trigger
trigger: none

jobs:
- job: nightly
  displayName : "Nightly tests windows CPU"
  timeoutInMinutes: 180

  pool:
    name: RecommendersAgentPoolWin

  steps:
  - script: |
      call conda env remove -n nightly_reco_base
      SET F="C:\Anaconda\envs\nightly_reco_base"
      IF EXIST %F% RMDIR /S /Q %F%
    displayName: 'Remove Conda Env if it exists'

  - script: |
      python ./scripts/generate_conda_file.py --name nightly_reco_base
      call conda env create -f nightly_reco_base.yaml
    displayName: 'Setup Conda Env'

  - script: |
      call conda activate nightly_reco_base
      echo "Show libraries"
      pip list
      echo "Smoke tests"
      pytest tests/smoke --durations 0 -m "smoke and not spark and not gpu" --junitxml=reports/test-smoke.xml
      echo "Integration tests"
      pytest tests/integration --durations 0 -m "integration and not spark and not gpu" --junitxml=reports/test-integration.xml
      call conda deactivate
    displayName: 'Run Tests'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results '
    inputs:
      testResultsFiles: '**/test-*.xml'
      failTaskOnFailedTests: true
    condition: succeededOrFailed()

  - script: |
      call conda env remove -n nightly_reco_base -y
      SET F="C:\Anaconda\envs\nightly_reco_base"
      IF EXIST %F% RMDIR /S /Q %F%
    workingDirectory: tests
    displayName: 'Conda remove'
    continueOnError: true
    condition: succeededOrFailed()

  - script: |
      del /q /S %LOCALAPPDATA%\Temp\*
      for /d %%i in (%LOCALAPPDATA%\Temp\*) do @rmdir /s /q "%%i"
    displayName: 'Remove Temp Files'
    condition: succeededOrFailed()
