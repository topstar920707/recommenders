pool:
  name: RecoDevTeam
  timeoutInMinutes: 120

steps:
- script: |
   conda env remove -n nightly_reco_pyspark && \
   python ./scripts/generate_conda_file.py --pyspark --name nightly_reco_pyspark && \
   conda env create --quiet -f nightly_reco_pyspark.yaml 2> log
  displayName: 'Setup Conda Env'
  timeoutInMinutes: 10
  env:
    PYSPARK_PYTHON: /anaconda/envs/nightly_reco_pyspark/bin/python
    PYSPARK_DRIVER_PYTHON: /anaconda/envs/nightly_reco_pyspark/bin/python

- script: |
   . /anaconda/etc/profile.d/conda.sh && \
   conda activate nightly_reco_pyspark && \
   unset SPARK_HOME && \
   echo "Smoke tests" && \
   pytest tests/smoke -m "smoke and spark and not gpu" --junitxml=reports/test-smoke.xml && \
   echo "Integration tests" && \
   pytest tests/integration -m "integration and spark and not gpu" --junitxml=reports/test-integration.xml && \
   conda deactivate
  displayName: 'Run Tests'
  timeoutInMinutes: 90
  env:
    PYSPARK_PYTHON: /anaconda/envs/nightly_reco_pyspark/bin/python
    PYSPARK_DRIVER_PYTHON: /anaconda/envs/nightly_reco_pyspark/bin/python

- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFiles: '**/test-*.xml'
    failTaskOnFailedTests: true
  condition: succeededOrFailed()

- script: 'conda env remove -n nightly_reco_pyspark'
  displayName: 'Remove Conda Env'
  condition: succeededOrFailed()
  timeoutInMinutes: 10

