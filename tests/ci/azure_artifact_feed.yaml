# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

#trigger:
#- master

# The global variables are defined in ADO/Pipelines/Library
# https://dev.azure.com/best-practices/recommenders/_library?itemType=VariableGroups
variables:
- group: LinuxAgentPool

jobs:
- job: Artifact
  displayName: 'Create Recommenders artifact'
  timeoutInMinutes: 30 # how long to run the job before automatically cancelling
  pool:
    name: $(Agent_Pool)

  steps:
  - bash: |
      echo "##vso[task.prependpath]/data/anaconda/bin"
      conda env list
    displayName: 'Add Conda to PATH'

  - script: |
      conda env remove -n $(env_name) -y   
    workingDirectory: tests
    displayName: 'Conda remove'
    continueOnError: true
    condition: always() # this step will always run, even if the pipeline is canceled

  - script: |
      python ./scripts/generate_conda_file.py --name $(env_name)
      conda env create --quiet -f $(env_name).yaml 2> log
    displayName: 'Setup Conda Env'

  - script: |
      . /anaconda/etc/profile.d/conda.sh && \
      conda activate $(env_name) && \
      pip install wheel twine keyring artifacts-keyring && \
      pip list
    displayName: 'Install dependencies'

  - script: |
      . /anaconda/etc/profile.d/conda.sh && \
      conda activate $(env_name) && \
      rm -rf dist && \
      HASH=True python setup.py sdist bdist_wheel
    displayName: 'Build wheel'

  # - task: TwineAuthenticate@1
  #   inputs:
  #     artifactFeed: recommenders/recommenders
  #   displayName: 'Twine Authenticate'

  # - script: |
  #     . /anaconda/etc/profile.d/conda.sh && \
  #     conda activate $(env_name) && \
  #     python -m twine upload -r recommenders --config-file $(PYPIRC_PATH) dist/*.whl --verbose
  #   displayName: 'Upload wheel'

  - script: |
      conda env remove -n $(env_name) -y   
    workingDirectory: tests
    displayName: 'Conda remove'
    continueOnError: true
    condition: always() # this step will always run, even if the pipeline is canceled
